name: nordmart-review-test

on: push

env:
  URL: "bilalbokharee/gitops-config-template"

jobs:
  update-versions:
    name: Update Versions
    runs-on: ubuntu-latest #stakater/pipeline-toolbox:v0.0.2
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          repository: "bilalbokharee/gitops-config-template"
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will fail to push refs to dest repo
      
      - name: Generate Tag
        id: generate_tag
        uses: anothrNick/github-tag-action@1.26.0
        env:
          GITHUB_TOKEN: ${{ secrets.STAKATER_GITHUB_TOKEN }}
          WITH_V: false
          DEFAULT_BUMP: patch
          DRY_RUN: true

      - run: |
          ls 
          pwd
          yq -i '.dependencies[0].version = "${{ steps.generate_operator_tag.outputs.new_tag }}"' 01-gabbar/apps/01-stakater-nordmart-review/01-dev/Chart.yaml
          yq -i '.version = "${{ steps.generate_operator_tag.outputs.new_tag }}"' 01-gabbar/apps/01-stakater-nordmart-review/01-dev/Chart.yaml 
          yq -i '.sample-app-helm.application.deployment.image.tag = "${{ steps.generate_operator_tag.outputs.new_tag }}"' 01-gabbar/apps/01-stakater-nordmart-review/01-dev/values.yaml
          echo "File updated"
        name: 'Update Chart'
    
    

      # Commit back changes
      - name: Commit files
        run: |
          git config --local user.email "github-root@stakater.com"
          git config --local user.name "stakater-github-root"
          git status
          git add .
          git commit -m "[skip-ci] Update artifacts" -a
          git diff --staged

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.STAKATER_GITHUB_TOKEN }}
          branch: main